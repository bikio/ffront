<input type="hidden" id="id" />

<div class="biohead" id=fishermanName></div>

<div class="sale">
	<div id=fisher-info></div>
</div>

<div id=fishList></div>


<script>
	function getFisherman(boat, date) {

		var getUrl = "http://fresh.freshfishalerts.appspot.com/getfisherman?boatName=" + boat;

		$
			.post(
				getUrl, {},
				function(data, status) {

					var result = jQuery.parseJSON(data);

					$("#id").val(result.ID);

					$("#fishermanName").html(
						'<img src="' + result.image + '=s74"  width="74" />' + '<p>' + result.fishermanName + '<br/>' + result.boatName + '</p>');

					$("#fisher-info")
						.html(
							date + '<br/>' + '<a href="https://www.google.com/maps/place/' + result.address + ', ' + result.city + '" target="_blank">' + result.address + ', ' + result.city + '</a><br/>' + result.phone);

					listFish(result.ID, date);
				});
	}

	function buyFish(fishID, fishermanID, city, fish, weight, price, priceType, quantity) {

		var parameters = "?id=" + "&fishermanfishID=" + fishID + "&fishermanID=" + fishermanID + "&distributorID=" + encodeURIComponent(getUrlParameter("distributor")) + "&distributordate=" + encodeURIComponent(date) + "&city=" + encodeURIComponent(city) + "&fish=" + encodeURIComponent(fish) + "&weight=" + encodeURIComponent(weight) + "&price=" + encodeURIComponent(price) + "&priceType=" + encodeURIComponent(priceType) + "&quantity=" + encodeURIComponent(quantity);

		if ((getUrlParameter("email") == null || getUrlParameter("email") == "")) {
			window.location.href = './email.html' + parameters;
		}
		else {

			var saveUrl = "http://fresh.freshfishalerts.appspot.com/savefishdistributor" + parameters;

			$.post(saveUrl, {}, function(data, status) {
				alert("Thank you for buying this fish.");
			});
		}
	}

	function listFish(id, date) {

		var fishList = '<table><thead><tr>' + '<th>fish</th>' + '<th>size(lb)</th>' + '<th><div id=priceType></div></th>' + '<th>qty</th>' + '</tr></thead><tbody>';

		var getUrl = "http://fresh.freshfishalerts.appspot.com/listfish?fisherman=" + id + "&date=" + date;
		$.post(getUrl, {}, function(data, status) {

			var priceType = "$/lb";
			var lastUpdate = "";

			var results = jQuery.parseJSON(data);

			$.each(results, function(key, val) {

				priceType = val.priceType;

				var buyFishCall = 'buyFish("' + val.fishID + '","' + val.fishermanID + '","' + val.city + '","' + val.fish + '","' + val.weight + '","' + val.price + '","' + val.priceType + '","' + val.quantity + '");';

				fishList += '<tr><td>' + val.fish + '</td><td>' + val.weight + '</td><td>$' + val.price + '</td><td>' + val.quantity + '</td><td>' + '<img src="/images/cart.png" onclick=' + buyFishCall + '></td></tr>';

				if (lastUpdate < val.timestamp) {
					lastUpdate = val.timestamp;
				}
			});

			fishList += '</tbody></table>';

			$("#fishList").html(fishList);
			$("#priceType").html(priceType);
			$("#fisher-info").append(
				'<br/>last update: ' + timestampToDate(lastUpdate));
		});
	}


	var boat = getUrlParameter("boat");
	var distributor = getUrlParameter("distributor");
	var date = getUrlParameter("date");

	if (date == null || date == 'null' || date == "" || date == "undefined") {
		date = getDate(new Date());
	}

	getFisherman(boat, date);
</script>
