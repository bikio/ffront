<input type="hidden" id="email" />

<div class="biohead" id=fishermanName></div>

<div class="sale">
	<div id=fisher-info></div>
</div>

<div id=fishList></div>


<script>
	var distributor;
	var fisherman;

	function getSeller(email, date) {

		var getUrl = "http://fresh.freshfishalerts.appspot.com/getuser?email=" + email;

		$
			.post(
				getUrl, {},
				function(data, status) {

					var result = jQuery.parseJSON(data);

					$("#email").val(result.ID);

					$("#fishermanName").html(
						'<img src="' + result.image + '=s74"  width="74" />' + '<p>' + result.contactName + '<br/>' + result.companyName + '</p>');

					$("#fisher-info")
						.html(
							date + '<br/>' + '<a href="https://www.google.com/maps/place/' + result.address + ', ' + result.city + '" target="_blank">' + result.address + ', ' + result.city + '</a><br/>' + result.phone);

					if (result.userType == "distributor") {
						distributor = result.ID;
						listFishdistributor(result.ID, date);
					}
					else {
						fisherman = result.ID;
						listFish(result.ID, date);
					}
				});
	}

	function buyFish(fishermanfishID, distributorfishID, fisherman, fishermandate, fishermantime, city, distributorfish, fish, distributormethod, method, weight, price, priceType, quantity) {

		var parameters = "?id=&fishermanfishID=" + fishermanfishID + "&distributorfishID=" + distributorfishID + "&fisherman=" + fisherman + "&buyer=" + getUrlParameter("user") + "&date=" + fishermandate + "&time=" + fishermantime + "&method=" + method + "&distributordate=" + date + "&city=" + city + "&distributorfish=" + distributorfish + "&distributormethod=" + distributormethod + "&fish=" + fish + "&weight=" + weight + "&price=" + price + "&priceType=" + priceType + "&quantity=" + quantity;

		if (getUrlParameter("user") == null || getUrlParameter("user") == "" || getUrlParameter("user") == "undefined") {
			window.location.href = './user.html' + parameters + "&distributor=" + encodeURIComponent(distributor);
		}
		else {

			var saveUrl;
			if (getUrlParameter("type") == 'distributor') {
				saveUrl = "http://fresh.freshfishalerts.appspot.com/savefishdistributor" + parameters + "&distributor=" + encodeURIComponent(getUrlParameter("user"));
			}
			else {
				saveUrl = "http://fresh.freshfishalerts.appspot.com/buyfish" + parameters + "&distributor=" + encodeURIComponent(distributor);
			}

			$.post(saveUrl, {}, function(data, status) {
				alert("Thank you for buying Freshr.");
			});
		}
	}

	function listFish(email, date) {

		var fishList = '<table><thead><tr>' + '<th>fish</th>' + '<th>size(lb)</th>' + '<th><div id=priceType></div></th>' + '<th>qty</th>' + '</tr></thead><tbody>';

		var getUrl = "http://fresh.freshfishalerts.appspot.com/listfish?fisherman=" + email + "&date=" + date;
		$.post(getUrl, {}, function(data, status) {

			var priceType = "$/lb";
			var lastUpdate = "";

			var results = jQuery.parseJSON(data);

			$.each(results, function(key, val) {

				priceType = val.priceType;

				var buyFishCall = 'buyFish("' + encodeURIComponent(val.ID) + '","","' + encodeURIComponent(val.fisherman) + '","' + encodeURIComponent(val.date) + '","' + encodeURIComponent(val.time) + '","' + encodeURIComponent(val.city) + '","' + encodeURIComponent(val.distributorfish) + '","' + encodeURIComponent(val.fish) + '","' + encodeURIComponent(val.distributormethod) + '","' + encodeURIComponent(val.method) + '","' + encodeURIComponent(val.weight) + '","' + encodeURIComponent(val.price) + '","' + encodeURIComponent(val.priceType) + '","' + encodeURIComponent(val.quantity) + '");';

				fishList += '<tr><td>' + val.fish + '</td><td>' + val.weight + '</td><td>$' + val.price + '</td><td>' + val.quantity + '</td><td>' + '<img src="/images/cart.png" onclick=' + buyFishCall + '></td></tr>';

				if (lastUpdate < val.timestamp) {
					lastUpdate = val.timestamp;
				}
			});

			fishList += '</tbody></table>';

			$("#fishList").html(fishList);
			$("#priceType").html(priceType);
			$("#fisher-info").append(
				'<br/>last update: ' + timestampToDate(lastUpdate));
		});
	}

	function listFishdistributor(email, date) {

		var fishList = '<table><thead><tr>' + '<th>caught</th>' + '<th>fish</th>' + '<th>size(lb)</th>' + '<th><div id=priceType></div></th>' + '<th>qty</th>' + '</tr></thead><tbody>';

		var getUrl = "http://fresh.freshfishalerts.appspot.com/listfishdistributor?distributor=" + email + "&distributordate=" + date;

		$.post(getUrl, {}, function(data, status) {

			var priceType = "$/lb";
			var lastUpdate = "";

			var results = jQuery.parseJSON(data);

			$.each(results, function(key, val) {

				priceType = val.priceType;
				var buyFishCall = 'buyFish("' + encodeURIComponent(val.fishermanfishID) + '","' + encodeURIComponent(val.ID) + '","' + encodeURIComponent(val.fisherman) + '","' + encodeURIComponent(val.date) + '","' + encodeURIComponent(val.time) + '","' + encodeURIComponent(val.city) + '","' + encodeURIComponent(val.distributorfish) + '","' + encodeURIComponent(val.fish) + '","' + encodeURIComponent(val.distributormethod) + '","' + encodeURIComponent(val.method) + '","' + encodeURIComponent(val.weight) + '","' + encodeURIComponent(val.price) + '","' + encodeURIComponent(val.priceType) + '","' + encodeURIComponent(val.quantity) + '");';

				fishList += '<tr><td>' + val.date + '</td><td>' + val.distributorfish + '</td><td>' + val.distributorweight + '</td><td>$' + val.distributorprice + '</td><td>' + val.distributorquantity + '</td><td>' + '<img src="/images/cart.png" onclick=' + buyFishCall + '></td></tr>';

				if (lastUpdate < val.timestamp) {
					lastUpdate = val.timestamp;
				}
			});

			fishList += '</tbody></table>';

			$("#fishList").html(fishList);
			$("#priceType").html(priceType);
			$("#fisher-info").append(
				'<br/>last update: ' + timestampToDate(lastUpdate));
		});
	}


	var seller = getUrlParameter("seller");
	var date = getUrlParameter("date");

	if (date == null || date == 'null' || date == "" || date == "undefined") {
		date = getDate(new Date());
	}

	getSeller(seller, date);
</script>
